<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Editor - Rutwik Video Editor</title>
    <!-- Note: CSS file path needs to be correct for styling -->
    <link rel="stylesheet" href="/rve/style.css"/> 
</head>
<body>

    <!-- Top Navigation Bar -->
    <nav class="editor-nav glass">
        <div class="nav-left">
            <a href="/rve/dashboard.html" id="logo-link">
                <img src="/rve/assets/rve-logo.png" alt="RVE Logo" class="rve-logo" />
            </a>
            <span class="rve-title">RVE</span>
        </div>
        <div class="nav-center">
            <input type="text" id="project-title-input" placeholder="Project File Name" />
        </div>
        <div class="nav-right">
            <button class="button">Download</button>
            <button class="button">Share</button>
            <button class="button">Next</button>
        </div>
    </nav>
    
    <!-- Custom visual alert box for debugging without console (FIX) -->
    <div id="rve-error-alert" style="
        position: fixed; top: 10px; right: 10px; 
        background: #ff4d4d; color: white; 
        padding: 10px; border-radius: 5px; 
        z-index: 9999; box-shadow: 0 4px 6px rgba(0,0,0,0.2); 
        max-width: 300px; display: none;">
    </div>

    <!-- Main Editor Layout -->
    <div class="editor-layout">
        
        <!-- Left Panel: Media Preview -->
        <section class="media-viewer glass">
            <h3 id="current-media-title">No Media Selected</h3>
            
            <!-- The single, official video player -->
            <video id="video-preview" controls></video>

            <!-- The upload controls are now a drag-and-drop zone style -->
            <div class="upload-zone">
                <!-- Input file is hidden via CSS. Accepts video and audio. -->
                <input type="file" id="video-upload" accept="video/*,audio/*" multiple /> 
                
                <!-- The visible button is the LABEL linked by 'for' -->
                <label for="video-upload" class="button" id="upload-label">
                    + Click to Add Files
                </label>
            </div>
        </section>

        <!-- Right Panel: Media Library & Project Info -->
        <div class="media-library-panel">
            
            <!-- Media Library List -->
            <div class="media-library glass">
                <h2>Media Library</h2>
                <div id="media-list" class="media-list">
                    <!-- Media items will be injected here -->
                    <p style="color: #666; font-size: 0.9em; padding: 10px;">
                        Upload a video or audio file to begin building your project library.
                    </p>
                </div>
            </div>

            <!-- Project Info & Save -->
            <main class="glass project-info">
                <h2 id="project-title">Loading Project...</h2>
                <input type="text" id="title-input" placeholder="Project Title" />
                <button class="button" id="save-btn">Save Project</button>
            </main>
        </div>
    </div>

    <!-- Editor Logic: FINAL SCRIPT BLOCK -->
    <script type="module">
        // Helper function to show a visual error message
        function displayVisualError(message) {
            let errorBox = document.getElementById("rve-error-alert");
            if (errorBox) {
                errorBox.textContent = message;
                errorBox.style.display = 'block';
                setTimeout(() => errorBox.style.display = 'none', 10000); // Hide after 10 seconds
            }
        }

        // Global library to store all imported media assets
        let mediaLibrary = [];
        let currentObjectURL = null; // Memory management variable

        function revokeCurrentURL() {
             if (currentObjectURL) {
                URL.revokeObjectURL(currentObjectURL);
                currentObjectURL = null;
            }
        }

        // Function to render the list of uploaded files
        function renderMediaLibrary(videoPreview, currentMediaTitle) {
            const mediaListContainer = document.getElementById('media-list');
            mediaListContainer.innerHTML = ''; // Clear existing list

            if (mediaLibrary.length === 0) {
                 mediaListContainer.innerHTML = '<p style="color: #666; font-size: 0.9em; padding: 10px;">Upload a video or audio file to begin building your project library.</p>';
                 return;
            }

            mediaLibrary.forEach((media, index) => {
                const item = document.createElement('div');
                item.className = 'media-list-item';
                // Font Awesome icons are assumed to be loaded for better visual experience
                const icon = media.type.startsWith('video') ? 'ðŸŽ¬' : 'ðŸŽµ'; 

                item.innerHTML = `
                    <span class="media-icon">${icon}</span>
                    <span class="media-name">${media.name}</span>
                `;

                item.addEventListener('click', () => {
                    // Load this item into the main preview player
                    loadMediaPreview(media, videoPreview, currentMediaTitle);
                    // Add active class for visual feedback (optional)
                    document.querySelectorAll('.media-list-item').forEach(el => el.style.backgroundColor = '#f4f4f9');
                    item.style.backgroundColor = '#dbeafe'; // A light blue to show active
                });

                mediaListContainer.appendChild(item);
            });
        }

        // Function to handle loading media into the preview
        function loadMediaPreview(media, videoPreview, currentMediaTitle) {
            // Revoke the URL of the previously loaded file
            revokeCurrentURL();

            // Set the new URL
            const newURL = media.url;
            currentObjectURL = newURL; // Update tracking variable

            // Set the source and title
            videoPreview.src = newURL;
            videoPreview.load(); // Force the browser to start loading the new media
            
            // Set the element type and display the title
            videoPreview.style.display = 'block';
            videoPreview.tagName = media.type.startsWith('audio') ? 'AUDIO' : 'VIDEO';
            videoPreview.setAttribute('type', media.type);
            currentMediaTitle.textContent = media.name;
        }

        window.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get("id");

            const currentMediaTitle = document.getElementById('current-media-title');
            
            // --- Project Initialization ---
            if (!projectId) {
                document.getElementById("project-title").textContent = "No project ID found.";
                return;
            }

            const project = {
                id: projectId,
                title: "Untitled Project",
                createdAt: new Date().toISOString(),
                lastEdited: new Date().toISOString()
            };

            document.getElementById("project-title").textContent = `Editing: ${project.title}`;
            document.getElementById("title-input").value = project.title;

            // --- Save Button Handler ---
            document.getElementById("save-btn").addEventListener("click", () => {
                const newTitle = document.getElementById("title-input").value;
                project.title = newTitle;
                project.lastEdited = new Date().toISOString();

                document.getElementById("project-title").textContent = `Editing: ${newTitle}`;
                document.title = `${newTitle} - Rutwik Video Editor`;

                console.log("Project saved locally:", project);
                displayVisualError("Project saved successfully!"); 
            });

            // --- Video Upload & Playback Logic ---
            const videoUpload = document.getElementById("video-upload");
            const videoPreview = document.getElementById("video-preview");
            const uploadLabel = document.getElementById("upload-label"); 

            if (!videoUpload || !videoPreview || !uploadLabel) {
                displayVisualError("CRITICAL RVE ERROR: Editor elements missing (x00003).");
                return;
            }

            // *** CRITICAL MEDIA ERROR HANDLER ***
            videoPreview.onerror = function() {
                let errorText = "MEDIA LOAD FAILED: Codec Unsupported or Corrupted!";
                if (videoPreview.error && videoPreview.error.code) {
                     errorText += ` (Code ${videoPreview.error.code})`;
                }
                document.getElementById("project-title").textContent = `!! ${errorText} !!`;
                displayVisualError(errorText);
            };
            
            // Handle the file selection (Change Handler)
            videoUpload.addEventListener("change", () => {
                const files = Array.from(videoUpload.files);
                if (files.length === 0) {
                    displayVisualError("No files selected.");
                    return;
                }

                // Revoke the URL of the previously loaded file for immediate memory cleanup
                revokeCurrentURL();
                
                // Process all new files
                files.forEach((file) => {
                    const newURL = URL.createObjectURL(file);
                    
                    mediaLibrary.push({
                        name: file.name,
                        type: file.type,
                        url: newURL,
                        file: file // Keep the original file object if needed later
                    });
                    
                    console.log(`Clip Added to Library: ${file.name}`);
                });

                // Render the entire library list
                renderMediaLibrary(videoPreview, currentMediaTitle);
                
                // Automatically load the LAST uploaded file into the preview
                const lastMedia = mediaLibrary[mediaLibrary.length - 1];
                if (lastMedia) {
                     // Use setTimeout (0ms) to bypass potential race conditions when setting src
                     setTimeout(() => {
                        loadMediaPreview(lastMedia, videoPreview, currentMediaTitle);
                    }, 0);
                }
            });
            
            // Initialize the list display
            renderMediaLibrary(videoPreview, currentMediaTitle);
        });
    </script>
    <!-- Editor Logic: END SCRIPT BLOCK -->

    <!-- for progress bar at the bottom -->
    <footer class="progress-footer glass">
        <div class="progress-bar">
            <div class="progress-step active" data-step="Import">Import</div>
            <div class="progress-step" data-step="Edit">Edit</div>
            <div class="progress-step" data-step="Music">Music</div>
            <div class="progress-step" data-step="Final Checks">Final Checks</div>
            <div class="progress-step" data-step="Export">Export</div>
            <div class="progress-step" data-step="Upload">Upload</div>
        </div>
    </footer>
    
</body>
</html>
